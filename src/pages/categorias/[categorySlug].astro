---
import Breadcrumb from "@/components/Breadcrumb.astro";
import { CategoryPageShell } from "@/components/catalog/CategoryPageShell";
import { PAGE_SIZE } from "@/config";
import BaseLayout from "@/layouts/BaseLayout.astro";
import {
  getCategoryAndSubcategories,
  getSubcategoryBySlugWithinCategory,
} from "@/lib/data/categories";
import {
  getProductsByCategory,
  getProductsBySubcategory,
} from "@/lib/data/products";

import type { AttributeFilters, ProductFilters } from "@/lib/data/types";
import { createClient } from "@/lib/supabase";

const { categorySlug } = Astro.params;

if (!categorySlug) {
  return Astro.redirect("/categorias");
}

const supabase = createClient({
  request: Astro.request,
  cookies: Astro.cookies,
});

const url = new URL(Astro.request.url);
const subcategorySlug = url.searchParams.get("subcategoria");
const page = parseInt(url.searchParams.get("page") || "1");
const pageSize = parseInt(
  url.searchParams.get("pageSize") || PAGE_SIZE.toString()
);
const sort = url.searchParams.get("sort") || null;
const minPrice = url.searchParams.get("minPrice");
const maxPrice = url.searchParams.get("maxPrice");
const inStock = url.searchParams.get("inStock") === "true";

const attributeFilters: AttributeFilters = {};
const reservedParams = [
  "subcategoria",
  "page",
  "pageSize",
  "sort",
  "minPrice",
  "maxPrice",
  "inStock",
];

url.searchParams.forEach((value, key) => {
  if (!reservedParams.includes(key) && value) {
    if (attributeFilters[key]) {
      if (Array.isArray(attributeFilters[key])) {
        (attributeFilters[key] as string[]).push(value);
      } else {
        attributeFilters[key] = [attributeFilters[key] as string, value];
      }
    } else {
      attributeFilters[key] = value;
    }
  }
});

console.log(attributeFilters);

const categoryData = await getCategoryAndSubcategories(supabase, categorySlug);

if (!categoryData) {
  return Astro.redirect("/categorias");
}

const { category, subcategories } = categoryData;

let currentSubcategory = null;
let filterConfig: any[] = [];

if (subcategorySlug) {
  const subcategoryData = await getSubcategoryBySlugWithinCategory(
    supabase,
    categorySlug,
    subcategorySlug
  );

  if (!subcategoryData) {
    return Astro.redirect(`/categorias/${categorySlug}`);
  }

  currentSubcategory = subcategoryData.subcategory;
  filterConfig = currentSubcategory.filter_config || [];
}

const filters: ProductFilters = {
  attributeFilters,
  minPrice: minPrice ? parseFloat(minPrice) : undefined,
  maxPrice: maxPrice ? parseFloat(maxPrice) : undefined,
  inStock: inStock || undefined,
  sort: sort as any,
};

let productsResponse;

if (currentSubcategory) {
  productsResponse = await getProductsBySubcategory(
    supabase,
    currentSubcategory.id,
    filters,
    { page, pageSize }
  );
} else {
  productsResponse = await getProductsByCategory(
    supabase,
    category.id,
    filters,
    { page, pageSize }
  );
}

const initialFilters = {
  subcategorySlug: subcategorySlug || null,
  page: productsResponse.page,
  pageSize: productsResponse.pageSize,
  sort: sort || null,
  attributeFilters,
  minPrice: filters.minPrice,
  maxPrice: filters.maxPrice,
  inStock: inStock,
};

const initialPagination = {
  page: productsResponse.page,
  pageSize: productsResponse.pageSize,
  total: productsResponse.total,
  totalPages: productsResponse.totalPages,
};

const pageTitle = currentSubcategory
  ? `${currentSubcategory.name} - ${category.name} | ARM`
  : `${category.name} | ARM`;

const pageDescription = currentSubcategory
  ? `Explora nuestra selección de ${currentSubcategory.name} en ${category.name}`
  : `Explora nuestra categoría de ${category.name}`;
---

<BaseLayout title={pageTitle} description={pageDescription}>
  <div class="container">
    <Breadcrumb
      category={category}
      currentSubcategorySlug={currentSubcategory?.slug}
    />
    <header>
      <h1 class="title">
        {currentSubcategory ? currentSubcategory.name : category.name}
      </h1>
    </header>

    <CategoryPageShell
      client:load
      category={JSON.parse(JSON.stringify(category))}
      subcategories={JSON.parse(JSON.stringify(subcategories))}
      currentSubcategory={currentSubcategory
        ? JSON.parse(JSON.stringify(currentSubcategory))
        : null}
      filterConfig={JSON.parse(JSON.stringify(filterConfig))}
      initialProducts={JSON.parse(JSON.stringify(productsResponse.items))}
      initialFilters={JSON.parse(JSON.stringify(initialFilters))}
      initialPagination={JSON.parse(JSON.stringify(initialPagination))}
    />
  </div>
</BaseLayout>

<style>
  .container {
    padding: 2rem 1rem;
    max-width: 1600px;
    margin: 0 auto;
  }
  header {
    margin-bottom: 1rem;
  }

  .title {
    font-size: var(--fs-xxl);
    font-family: var(--font-primary);
    font-weight: 450;
  }
</style>
